From 04f4c62ad1703bf33e9975952bfba5faf3d6858c Mon Sep 17 00:00:00 2001
From: "Echo J." <aidas957@gmail.com>
Date: Tue, 14 Nov 2023 09:23:07 +0200
Subject: [PATCH] nvk: Fixup for pipeline caching on NAK

---
 src/nouveau/vulkan/nvk_shader.c | 18 +++++++++++++-----
 1 file changed, 13 insertions(+), 5 deletions(-)

diff --git a/src/nouveau/vulkan/nvk_shader.c b/src/nouveau/vulkan/nvk_shader.c
index 29ec5727742..e43e786e360 100644
--- a/src/nouveau/vulkan/nvk_shader.c
+++ b/src/nouveau/vulkan/nvk_shader.c
@@ -1340,19 +1340,27 @@ nvk_compile_nir(struct nvk_device *dev, nir_shader *nir,
    struct nv50_ir_prog_info *info;
    struct nv50_ir_prog_info_out info_out = {};
    int ret;
+   VkResult nak_ret;
    struct nvk_physical_device *pdev = nvk_device_physical(dev);
 
+   struct nvk_shader *shader = nvk_shader_init(dev, hash, SHA1_DIGEST_LENGTH);
+   if (shader == NULL)
+      return vk_error(dev, VK_ERROR_OUT_OF_HOST_MEMORY);
+
    if (use_nak(pdev, nir->info.stage))
-      return nvk_compile_nir_with_nak(pdev, nir, fs_key, shader);
+   {
+      nak_ret = nvk_compile_nir_with_nak(pdev, nir, fs_key, shader);
+
+      if (nak_ret == VK_SUCCESS)
+         *shader_out = shader;
+
+      return nak_ret;
+   }
 
    info = CALLOC_STRUCT(nv50_ir_prog_info);
    if (!info)
       return false;
 
-   struct nvk_shader *shader = nvk_shader_init(dev, hash, SHA1_DIGEST_LENGTH);
-   if(shader == NULL)
-      return vk_error(dev, VK_ERROR_OUT_OF_HOST_MEMORY);
-
    info->type = pipe_shader_type_from_mesa(nir->info.stage);
    info->target = pdev->info.chipset;
    info->bin.nir = nir;
-- 
2.42.1

